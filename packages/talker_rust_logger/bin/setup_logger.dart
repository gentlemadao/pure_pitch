#!/usr/bin/env dart
// Copyright (c) 2026. Licensed under the MIT OR Apache-2.0 License.
// SPDX-License-Identifier: MIT OR Apache-2.0

import 'dart:io';

const rustTemplate = r'''
use crate::frb_generated::StreamSink;

// --- Data Structures (Generated locally for FRB) ---

#[derive(Clone, Debug)]
pub enum LogLevel {
    Trace,
    Debug,
    Info,
    Warn,
    Error,
}

#[derive(Clone, Debug)]
pub struct LogEntry {
    pub time_millis: i64,
    pub level: LogLevel,
    pub tag: String,
    pub msg: String,
}

// --- Converters ---

impl From<talker_rust_logger::LogLevel> for LogLevel {
    fn from(l: talker_rust_logger::LogLevel) -> Self {
        match l {
            talker_rust_logger::LogLevel::Trace => LogLevel::Trace,
            talker_rust_logger::LogLevel::Debug => LogLevel::Debug,
            talker_rust_logger::LogLevel::Info => LogLevel::Info,
            talker_rust_logger::LogLevel::Warn => LogLevel::Warn,
            talker_rust_logger::LogLevel::Error => LogLevel::Error,
        }
    }
}

impl From<talker_rust_logger::LogEntry> for LogEntry {
    fn from(e: talker_rust_logger::LogEntry) -> Self {
        Self {
            time_millis: e.time_millis,
            level: e.level.into(),
            tag: e.tag,
            msg: e.msg,
        }
    }
}

// --- Log Stream Entry Point ---

pub fn create_log_stream(sink: StreamSink<LogEntry>) {
    let sink = sink.clone();
    // Register the callback with the library.
    // This connects the library's logger to the FRB stream.
    // NOTE: This initializes the logger to ONLY send logs to Talker (Dart).
    // If you want native platform logs (Logcat/Console) as well, use `init_with_logger` 
    // and pass your platform logger implementation.
    let _ = talker_rust_logger::init(move |entry| {
        let _ = sink.add(entry.into());
    });
}
''';

void main(List<String> args) async {
  stdout.writeln('üî® Setting up talker_rust_logger...');

  final projectRoot = Directory.current;
  final rustApiDir = Directory('${projectRoot.path}/rust/src/api');

  if (!await rustApiDir.exists()) {
    stderr.writeln('‚ùå Error: Directory "rust/src/api" not found.');
    stderr.writeln(
        '   Please run this command from the root of a Flutter project configured with flutter_rust_bridge.');
    exit(1);
  }

  // 1. Setup logging.rs
  final loggingFile = File('${rustApiDir.path}/logging.rs');

  if (!await loggingFile.exists()) {
    stdout.writeln('üìù Creating rust/src/api/logging.rs...');
    await loggingFile.writeAsString(
        '// Auto-generated by talker_rust_logger\n$rustTemplate');
  } else {
    final content = await loggingFile.readAsString();
    if (content.contains('define_talker_log_stream')) {
      stdout.writeln(
          'üìù Upgrading rust/src/api/logging.rs from macro to template...');
      await loggingFile.writeAsString(
          '// Auto-generated by talker_rust_logger\n$rustTemplate');
    } else if (!content.contains('create_log_stream')) {
      stdout.writeln('üìù Appending template to rust/src/api/logging.rs...');
      final prefix = content.endsWith('\n') ? '' : '\n';
      await loggingFile.writeAsString('$prefix$rustTemplate',
          mode: FileMode.append);
    } else {
      stdout.writeln('‚úÖ rust/src/api/logging.rs is already configured.');
    }
  }

  // 2. Setup mod.rs
  final modFile = File('${rustApiDir.path}/mod.rs');
  if (await modFile.exists()) {
    final content = await modFile.readAsString();
    if (!content.contains('mod logging;')) {
      stdout.writeln('üìù Adding module export to rust/src/api/mod.rs...');
      final prefix = content.endsWith('\n') ? '' : '\n';
      await modFile.writeAsString('${prefix}pub mod logging;\n',
          mode: FileMode.append);
    } else {
      stdout.writeln('‚úÖ rust/src/api/mod.rs is already configured.');
    }
  } else {
    stdout.writeln('üìù Creating rust/src/api/mod.rs...');
    await modFile.writeAsString('pub mod logging;\n');
  }

  // 3. Setup Cargo.toml
  final cargoTomlFile = File('${projectRoot.path}/rust/Cargo.toml');
  if (await cargoTomlFile.exists()) {
    final content = await cargoTomlFile.readAsString();
    if (!content.contains('talker_rust_logger')) {
      stdout.writeln(
          '‚ö†Ô∏è Warning: "talker_rust_logger" dependency missing in rust/Cargo.toml.');
      stdout.writeln(
          '   Please add the following to your [dependencies] section:');
      stdout.writeln(
          '   talker_rust_logger = { path = "../packages/talker_rust_logger/rust" } # Or git/crates.io dependency');
    } else {
      stdout.writeln('‚úÖ rust/Cargo.toml seems to have the dependency.');
    }
  }

  stdout.writeln('\nüéâ Setup complete!');
  stdout.writeln('Next steps:');
  stdout.writeln(
      '1. Run `flutter_rust_bridge_codegen generate` to generate Dart bindings.');
  stdout.writeln('2. Initialize the logger in your Dart code:');
  stdout.writeln(
      '   await TalkerRustLogger.init(talker: talker, logStream: frb.createLogStream(), ...);');
}
